/*
 * Copyright (c) 2012, Daniel Walton (daniel@belteshazzar.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of the <organization> nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

var ckwnc=new function(){CanvasRenderingContext2D.prototype.dashedLine=function(a,b,c,d,e){this.beginPath();var f=function(a,b){return a<=b};var g=function(a,b){return a>=b};var h=function(a,b){return Math.min(a,b)};var i=function(a,b){return Math.max(a,b)};var j={thereYet:g,cap:h};var k={thereYet:g,cap:h};if(b-d>0){k.thereYet=f;k.cap=i}if(a-c>0){j.thereYet=f;j.cap=i}this.moveTo(a,b);var l=a;var m=b;var n=0,o=true;while(!(j.thereYet(l,c)&&k.thereYet(m,d))){var p=Math.atan2(d-b,c-a);var q=e[n];l=j.cap(c,l+Math.cos(p)*q);m=k.cap(d,m+Math.sin(p)*q);if(o)this.lineTo(l,m);else this.moveTo(l,m);n=(n+1)%e.length;o=!o}this.stroke()};CanvasRenderingContext2D.prototype.solidRightArrow=function(a,b){this.beginPath();this.moveTo(a,b);this.lineTo(a-7,b-7);this.lineTo(a-7,b+7);this.closePath();this.fill()};CanvasRenderingContext2D.prototype.solidLeftArrow=function(a,b){this.beginPath();this.moveTo(a,b);this.lineTo(a+7,b-7);this.lineTo(a+7,b+7);this.closePath();this.fill()};CanvasRenderingContext2D.prototype.rightArrow=function(a,b){this.beginPath();this.moveTo(a-7,b-7);this.lineTo(a,b);this.lineTo(a-7,b+7);this.stroke()};CanvasRenderingContext2D.prototype.leftArrow=function(a,b){this.beginPath();this.moveTo(a+7,b-7);this.lineTo(a,b);this.lineTo(a+7,b+7);this.stroke()};CanvasRenderingContext2D.prototype.cross=function(a,b){this.beginPath();this.moveTo(a-10,b-10);this.lineTo(a+10,b+10);this.stroke();this.beginPath();this.moveTo(a+10,b-10);this.lineTo(a-10,b+10);this.stroke()};var a=20;var b=20;var c=50;var d=20;var e=30;var f=10;var g=20;var h=20;var i="normal 14px sans-serif";var j="black";var k="black";var l=30;var m=[8,5];var n=10;var o=5;var p="#B2B2B2";var q="#D1D1D1";var r=1;var s=16;var t=function(a,b){var c=b.markOut(0,a,true);while(c.deferred.length>0){var d=c.deferred.shift();var e=d.section.markOut(d.y,a,true)}};var u=function(){var t=new Array;var u=new Array;var v=new Array;var w=0;this.count=function(){return t.length};this.lineCount=function(){return u.length};this.setCreateAt=function(a,b){var c=t[a];if(c.createAt!=0)return false;for(var d=0;d<c.invokes.length;d++){if(c.invokes[d].from<=b)return false}for(var e=0;e<u.length;e++){var f=u[e];if((f.from==a||f.to==a)&&b>=f.y){return false}}c.createAt=b;return true};this.add=function(a,b){t.push(new function(){this.getName=function(){return a};this.getClass=function(){return b};this.createAt=0;this.destroyAt=1e6;this.invokes=new Array;this.invokesAt=function(a){var b=0;for(var c=0;c<this.invokes.length;c++){if(this.invokes[c].from<=a&&a<=this.invokes[c].to){b=this.invokes[c].level}}return b};this.maxInvokes=function(){var a=0;for(var b=0;b<this.invokes.length;b++){if(this.invokes[b].to>a){a=this.invokes[b].to}}return a};this.invokeBoundaryAt=function(a){for(var b=0;b<this.invokes.length;b++){if(this.invokes[b].to==a||this.invokes[b].from==a)return true}return false}});return t.length-1};this.indexOf=function(a){for(var b=0;b<t.length;b++){if(t[b].getName()==a||t[b].getClass()==a){return b}}return-1};this.get=function(a){return t[a]};this.markInvoke=function(a,b,c){var d=t[a];var e=d.invokesAt(b)+1;w++;d.invokes.push({id:w,from:b,to:c,level:e});return w};this.incInvoke=function(a,b){for(var c=0;c<t[a].invokes.length;c++){if(t[a].invokes[c].id==b){t[a].invokes[c].to++;return}}};this.getInvoke=function(a,b){for(var c=0;c<t[a].invokes.length;c++){if(t[a].invokes[c].id==b){return t[a].invokes[c]}}return null};this.markLine=function(a,b,c,d,e,f,g,h,i){var j={from:a,to:b,y:c,isDashed:d,text:e,asynch:f,fromInvokeId:g,toInvokeId:h,invisible:i};u.push(j);return j};this.markArea=function(a,b,c,d,e){v.push({from:a,to:b,left:c,right:d,text:e})};this.lineAt=function(a,b,c){var d=Math.min(a,b);var e=Math.max(a,b);for(var f=0;f<u.length;f++){var g=u[f];var h=Math.min(g.from,g.to);var i=Math.max(g.from,g.to);if(g.y==c){if(d>h&&d>i)continue;else if(h>d&&h>e)continue;else return true}}return false};this.invokeBoundaryAt=function(a,b,c){for(var d=a;d<=b;d++){if(t[d].invokeBoundaryAt(c))return true}return false};this.getWidth=function(b){var e=a;b.font=i;for(var g=0;g<t.length;g++){var h=t[g];var j=h.getName()+":"+h.getClass();if(g!=0){e=e+d}e=e+Math.max(b.measureText(j).width+f*2,c)}e=e+a+40;return e};this.getHeight=function(){var a=0;for(var c=0;c<t.length;c++){if(t[c].maxInvokes()>a)a=t[c].maxInvokes()}return b*2+e+(a+1)*l+n};this.draw=function(w){var x=w.getContext("2d");x.font=i;x.strokeStyle="black";x.fillStyle="white";x.fillRect(0,0,w.getAttribute("width"),w.getAttribute("height"));x.fillStyle="black";x.lineWidth=r;var y=0;for(var z=0;z<t.length;z++){if(t[z].maxInvokes()>y)y=t[z].maxInvokes()}for(var z=0;z<t.length;z++){var A=t[z];var B=A.getName()+":"+A.getClass();if(z==0){A.left=a}else{A.left=t[z-1].left+t[z-1].width+d}A.width=Math.max(x.measureText(B).width+f*2,c);A.top=b;A.bottom=b+e;A.center=Math.round(A.left+A.width/2);x.strokeStyle=j;var C=0;if(A.createAt>0){C=n+e/2+A.createAt*l}if(A.getClass().toLowerCase()=="actor"){x.beginPath();x.moveTo(A.center,A.top+e/3);x.lineTo(A.center,A.bottom-e/3);x.lineTo(A.center-e/6,A.bottom);x.moveTo(A.center,A.bottom-e/3);x.lineTo(A.center+e/6,A.bottom);x.moveTo(A.center-e/6,A.top+e/2);x.lineTo(A.center+e/6,A.top+e/2);x.stroke();var D=x.createLinearGradient(A.center-e/6,A.top,A.center+e/6,A.top);D.addColorStop(0,p);D.addColorStop(1,q);x.fillStyle=D;x.beginPath();x.arc(A.center,A.top+e/6,e/6,0,Math.PI*2,true);x.fill();x.beginPath();x.arc(A.center,A.top+e/6,e/6,0,Math.PI*2,true);x.stroke()}else{var D=x.createLinearGradient(A.left,A.top+C,A.left,A.top+C+e);D.addColorStop(0,p);D.addColorStop(1,q);x.fillStyle=D;x.fillRect(A.left,A.top+C,A.width,e);x.strokeRect(A.left,A.top+C,A.width,e);x.textAlign="center";x.fillStyle=k;x.fillText(B,A.center,A.top+g+C)}if(A.destroyAt<1e6){x.dashedLine(A.center,A.bottom+C,A.center,A.destroyAt*l+b+e+n,m);x.cross(A.center,A.destroyAt*l+b+e+n)}else{x.dashedLine(A.center,A.bottom+C,A.center,(y+1)*l+b+e+n,m)}for(var E=0;E<A.invokes.length;E++){A.invokes[E].level=A.invokesAt(A.invokes[E].from)}for(var F=1;;F++){var G=false;for(var E=0;E<A.invokes.length;E++){var H=A.invokes[E];if(H.level==F){G=true;var I=A.invokesAt(H.from);var K=0;if(F==1&&A.createAt>0&&A.createAt==H.from){K=e/2}var D=x.createLinearGradient(A.center-h/2+(I-1)*h/2,0,A.center+h/2+(I-1)*h/2,0);D.addColorStop(0,p);D.addColorStop(1,q);x.fillStyle=D;x.fillRect(A.center-h/2+(I-1)*h/2,H.from*l+b+e+n+K,h,(H.to-H.from)*l-K);x.strokeStyle="black";x.strokeRect(A.center-h/2+(I-1)*h/2,H.from*l+b+e+n+K,h,(H.to-H.from)*l-K)}}if(!G)break}}for(var z=0;z<u.length;z++){var L=u[z];if(L.invisible)continue;var M=t[L.from].center;var N=t[L.to].center;var O=this.getInvoke(L.from,L.fromInvokeId);if(O==null)O=t[L.from].invokesAt(L.y);else O=O.level;var P=this.getInvoke(L.to,L.toInvokeId);if(P==null)P=t[L.to].invokesAt(L.y);else{if(L.to!=L.from&&P.level!=t[L.to].invokesAt(L.y)){J("warning to @ "+L.y);x.strokeStyle="red";x.strokeRect(t[L.to].center-h/2+(P.level-1)*h/2,P.from*l+b+e+n,h,(P.to-P.from)*l);x.strokeStyle="black"}P=P.level}if(L.from<L.to){M=M+h/2*O;N=N+h/2*P-h;x.textAlign="left";if(L.text=="create"&&L.y==t[L.to].createAt){L.text="<<create>>";N-=t[L.to].width/2-h/2}else if(L.text=="destroy"){L.text="<<destroy>>"}x.fillStyle="black";x.fillText(L.text,M+o,L.y*l+n+b+e-o);if(L.asynch)x.rightArrow(N,L.y*l+n+b+e);else x.solidRightArrow(N,L.y*l+n+b+e)}else if(L.from>L.to){M=M+h/2*O-h;N=N+h/2*P;x.fillStyle="black";x.textAlign="right";if(L.text=="create"&&L.y==t[L.to].createAt){L.text="<<create>>";N+=t[L.to].width/2-h/2}else if(L.text=="destroy"&&L.y+2==t[L.to].destroyAt){L.text="<<destroy>>"}x.fillStyle="black";x.fillText(L.text,M-o,L.y*l+n+b+e-o);if(L.asynch)x.leftArrow(N,L.y*l+n+b+e);else x.solidLeftArrow(N,L.y*l+n+b+e)}else{x.strokeStyle="black";x.fillStyle="black";M=M+h/2*(O-1);N=M;var Q=t[L.from].invokesAt(L.y)<t[L.from].invokesAt(L.y+1);if(Q){x.textAlign="left";x.fillText(L.text,M+h/2+o,L.y*l+n+b+e-o);if(!L.isDashed){x.beginPath();x.moveTo(M+h/2,L.y*l+n+b+e);x.lineTo(M+3*h/2,L.y*l+n+b+e);x.stroke()}else{x.dashedLine(M+h/2,L.y*l+n+b+e,M+3*h/2,L.y*l+n+b+e,m)}}else{if(!L.isDashed){x.beginPath();x.moveTo(M+h,L.y*l+n+b+e);x.lineTo(M+3*h/2,L.y*l+n+b+e);x.stroke()}else{x.dashedLine(M+h,L.y*l+n+b+e,M+h/2,L.y*l+n+b+e,m)}}if(!L.isDashed){x.beginPath();x.moveTo(M+3*h/2,L.y*l+n+b+e);x.lineTo(M+3*h/2,(L.y+1)*l+n+b+e);x.stroke()}else{x.dashedLine(M+2*h/2,L.y*l+n+b+e,M+2*h/2,(L.y+1)*l+n+b+e,m)}if(Q){if(!L.isDashed){x.beginPath();x.moveTo(M+h,(L.y+1)*l+n+b+e);x.lineTo(M+3*h/2,(L.y+1)*l+n+b+e);x.stroke()}else{x.dashedLine(M,L.y*l+n+b+e,M+3*h/2,(L.y+1)*l+n+b+e,m)}if(L.asynch)x.leftArrow(M+h,(L.y+1)*l+n+b+e);else x.solidLeftArrow(M+h,(L.y+1)*l+n+b+e)}else{if(!L.isDashed){x.beginPath();x.moveTo(M+h/2,(L.y+1)*l+n+b+e);x.lineTo(M+3*h/2,(L.y+1)*l+n+b+e);x.stroke()}else{x.dashedLine(M,(L.y+1)*l+n+b+e,M+2*h/2,(L.y+1)*l+n+b+e,m)}if(L.asynch)x.leftArrow(M,(L.y+1)*l+n+b+e);else x.solidLeftArrow(M,(L.y+1)*l+n+b+e)}}if(M!=N){if(!L.isDashed){x.beginPath();x.moveTo(M,L.y*l+n+b+e);x.lineTo(N,L.y*l+n+b+e);x.stroke()}else{x.dashedLine(M,L.y*l+n+b+e,N,L.y*l+n+b+e,m)}}}for(var z=0;z<v.length;z++){var R=v[z];try{var S=t[R.left].center-40;var T=R.from*l+b+e+n;var U=0;for(var V=R.from;V<=R.to;V++)if(t[R.right].invokesAt(V)>U)U=t[R.right].invokesAt(V);U++;var W=11*R.text.length;var D=x.createLinearGradient(S,T,S,T+s+8);D.addColorStop(0,p);D.addColorStop(1,q);x.fillStyle=D;x.beginPath();x.moveTo(S,T);x.lineTo(S,T+s+8);x.lineTo(S+W,T+s+8);x.lineTo(S+W+10,T+s+8-10);x.lineTo(S+W+10,T);x.fill();x.beginPath();x.moveTo(S,T+s+8);x.lineTo(S+W,T+s+8);x.lineTo(S+W+10,T+s+8-10);x.lineTo(S+W+10,T);x.stroke();x.strokeRect(S,T,t[R.right].center-S+h*U,(R.to-R.from)*l);x.fillStyle="black";x.textAlign="left";x.fillText(R.text,S+5,T+s)}catch(X){alert(X);J("failed to draw area rectangle: a.from="+R.from+",a.to="+R.to)}}}};var v=function(a,b){var c=a;var d=b;var e=new Array;var f=new Array;var g=1e6;var h=-1;var i=1e6;this.count=function(){return e.length};this.get=function(a){return e[a]};this.add=function(a,b,c,d,f){e.push(new function(){this.from=a;this.to=b;this.name=c;this.asynch=d;this.sub=f})};var j;this.markInvoke=function(a,b,c,d){return a.markInvoke(b,c,d)};this.incInvoke=function(a){a.incInvoke(d,j);if(c!=null)c.incInvoke(a)};this.markLine=function(a,b,c,d,e,f,i,j,k,l){var m=Math.max(b,c);var n=Math.min(b,c);if(m>h)h=m;if(n<g)g=n;return a.markLine(b,c,d,e,f,i,j,k,l)};this.markOut=function(b,c,f){if(f){j=this.markInvoke(c,d,b,b+1)}b++;var k=Array();var l=null;if(e.length>0)l=e[0].from;for(var m=0;m<e.length;m++){var n=e[m];var o=c.get(n.from);var p=c.get(n.to);while(true){if(c.lineAt(n.from,n.to,b)){b++;this.incInvoke(c);continue}if(c.get(n.to).createAt>b){b++;this.incInvoke(c);continue}if(n.from<n.to){if(c.invokeBoundaryAt(n.from+1,n.to,b)){b++;this.incInvoke(c);continue}}if(n.from>n.to){if(c.invokeBoundaryAt(n.to,n.from-1,b)){b++;this.incInvoke(c);continue}}break}if(n.sub!=null){if(!n.asynch){if(n.name.substring(0,4)=="loop"&&n.from==n.to){J("loop");J("loop top = "+b);i=b;t=null}else if(n.from!=n.to&&n.name=="create"){var q=c.setCreateAt(n.to,b);if(q)t=this.markLine(c,n.from,n.to,b,true,n.name,true,j,null,false);else t=this.markLine(c,n.from,n.to,b,false,n.name,false,j,null,false)}else if(n.from!=n.to&&n.name=="destroy"){t=this.markLine(c,n.from,n.to,b,true,n.name,true,j,null,false)}else{t=this.markLine(c,n.from,n.to,b,false,n.name,false,j,null,false)}J("top line not defined? "+t);if(n.from==n.to){b++;this.incInvoke(c)}var r=n.sub.markOut(b,c,n.name.substring(0,4)!="loop");if(t!=null)t.toInvokeId=r.invokeId;b=r.y;if(r.section_left<g)g=r.section_left;if(r.section_right>h)h=r.section_right;while(r.deferred.length>0)k.push(r.deferred.shift());while(true){if(c.lineAt(n.from,n.to,b)){b++;this.incInvoke(c);if(t!=null)c.incInvoke(t.to,t.toInvokeId);continue}else if(c.invokeBoundaryAt(Math.min(n.from,n.to)+1,Math.max(n.to,n.from)-1,b)){b++;this.incInvoke(c);if(t!=null)c.incInvoke(t.to,t.toInvokeId);continue}break}if(n.from!=n.to&&n.name=="destroy"){var s=1;while(c.lineAt(n.to,n.to,b+s))s++;c.get(n.to).destroyAt=b+s;this.markLine(c,n.to,n.to,b+s,true,n.name,true,j,null,true)}else if(n.name.substring(0,4)!="loop"){this.markLine(c,n.to,n.from,b,true,"",true,r.invokeId,j,false)}this.incInvoke(c);if(n.name.substring(0,4)=="loop"){b++;J("loop bottom = "+b);J("loop: "+n.name);J("bounds: top="+i+",left="+g+",bottom="+b+",right="+h);c.markArea(i,b,g,h,n.name);this.markLine(c,g,h,i,true,n.name,true,j,null,true);this.markLine(c,g,h,b,true,n.name,true,j,null,true);this.incInvoke(c)}else if(n.from==n.to){b++;this.markLine(c,n.to,n.from,b,true,"",false,r.invokeId,j,true);this.incInvoke(c)}}else{while(true){if(c.lineAt(n.from,n.to,b)){b++;this.incIncoke(c);continue}else if(c.invokeBoundaryAt(Math.min(n.from,n.to)+1,Math.max(n.from,n.to)-1,b)){b++;this.incInvoke(c);continue}break}this.markLine(c,n.from,n.to,b,false,n.name,true,j,null,false);if(n.from==n.to){b++;this.incInvoke(c)}k.push({y:b,section:n.sub})}}else{if(!n.asynch){var t;if(n.from!=n.to&&n.name=="create"){var q=c.setCreateAt(n.to,b);if(q)t=this.markLine(c,n.from,n.to,b,true,n.name,true,j,null,false);else t=this.markLine(c,n.from,n.to,b,false,n.name,false,j,null,false)}else if(n.from!=n.to&&n.name=="destroy"){var s=2;while(c.lineAt(n.to,n.to,b+s))s++;c.get(n.to).destroyAt=b+s;t=this.markLine(c,n.from,n.to,b,true,n.name,true,j,null,false);this.markLine(c,n.to,n.to,b+s,true,n.name,true,j,null,true)}else if(n.name=="pause"){this.incInvoke(c);b++;continue}else{t=this.markLine(c,n.from,n.to,b,false,n.name,false,j,null,false);if(n.from==n.to){b++;this.incInvoke(c)}}var u=this.markInvoke(c,n.to,b,b+1);t.toInvokeId=u.invokeId;this.incInvoke(c);b++;while(true){if(c.lineAt(n.from,n.to,b)){c.incInvoke(n.to,u);this.incInvoke(c);b++;continue}else if(c.invokeBoundaryAt(Math.min(n.from,n.to)+1,Math.max(n.from,n.to)-1,b)){c.incInvoke(n.to,u);this.incInvoke(c);b++;continue}break}this.markLine(c,n.to,n.from,b,true,"",true,u.invokeId,j,n.name=="create"||n.name=="destroy");if(n.from==n.to){b++;this.incInvoke(c)}else if(n.name=="destroy"){this.markLine(c,n.to,n.to,b+1,true,"",true,u.invokeId,u.invokeId,true)}}else{var t=this.markLine(c,n.from,n.to,b,false,n.name,true,j,null,false);if(n.from==n.to){b++;this.incInvoke(c)}var u=this.markInvoke(c,n.to,b,b+1);this.incInvoke(c);b++}}this.incInvoke(c);b++}if(a==null){while(k.length>0){var v=k.shift();var r=v.section.markOut(v.y,c,true);if(r.section_left<this.section_left)this.section_left=r.section_left;if(r.section_right>this.section_right)this.section_right=r.section_right}}return{y:b,invokeId:j,deferred:k,section_left:g,section_right:h}}};var w=function(a,b,c){this.getRow=function(){return a==null?-1:a.row()};this.getCol=function(){return a==null?-1:a.col()};this.getMsg=function(){var c="";for(var d=0;d<=this.getCol();d++)c+=" ";c+="^<br/>";return c+"Expected "+b+", found "+(a==null?"EOF":a.str())+" instead."}};var x=function(a,b,c,d,e,f){var g=new v(a,c);while(true){var h=d.pop();if(h==null){return g}else if(h.type()==G){if(d.peek()==null){e.push(new w(null,"class name after ':'",1));return g}h=d.pop();if(h.type()!=z){e.push(new w(h,"class name after ':'",2));continue}if(b.indexOf(h.str())==-1){b.add("",h.str())}}else if(h.type()==B){if(f){e.push(new w(h,"identifier or ':'",21));continue}else{d.unpop();return g}}else if(h.type()==z){var i=h;h=d.pop();if(h==null){e.push(new w(null,"':','.','>' or '('",3));return g}if(h.type()==G){var j=i.str();if(d.peek()==null){e.push(new w(null,"class name",4));return g}h=d.pop();if(h.type()!=z){e.push(new w(h,"class name",5));continue}var k=h.str();if(b.indexOf(j)==-1){b.add(j,k)}}else if(h.type()==E||h.type()==F){var l=h.str()==">";var j=i.str();h=d.pop();if(h==null){e.push(new w(null,"method name",6));return g}if(h.type()!=z){e.push(new w(h,"method name",7));continue}var m=h.str();if(d.peek()==null){e.push(new w(null,"'('",8));return g}h=d.pop();if(h.type()!=C){e.push(new w(h,"'('",9));continue}h=d.pop();if(h==null){e.push(new w(null,"parameters or ')'",10));return g}if(h.type()==z){m+="("+h.str()+")";h=d.pop();if(h==null){e.push(new w(null,"')'",11));return g}}if(h.type()!=D){e.push(new w(h,"')'",12));continue}var n=b.indexOf(j);if(n==-1){n=b.add("",j)}if(d.peek()!=null&&d.peek().type()==A){d.pop();var o;if(l)o=x(null,b,n,d,e,false);else o=x(g,b,n,d,e,false);h=d.pop();if(h==null){e.push(new w(null,"}",13));return g}if(h.type()!=B){e.push(new w(h,"}",14));continue}g.add(c,n,m,l,o);continue}else{g.add(c,n,m,l,null);continue}}else if(h.type()==C){var m=i.str();h=d.pop();if(h==null){e.push(new w(null,"parameters or ')'",15));return g}if(h.type()==z){m+="("+h.str()+")";h=d.pop();if(h==null){e.push(new w(null,")",16));return g}}if(h.type()!=D){e.push(new w(h,")",17));continue}if(d.peek()!=null&&d.peek().str()=="{"){d.pop();var o=x(g,b,c,d,e,false);g.add(c,c,m,false,o);h=d.pop();if(h==null){e.push(new w(h,"}",18));return g}if(h.type()!=B){e.push(new w(h,"}",19));continue}}else{g.add(c,c,m,false,null)}}else{e.push(new w(h,"'.','>',':' or '('",20));continue}}else{e.push(new w(h,"identifier, }, or EOF",21))}}return g};var y=function(){var a=new Array;var b=0;this.push=function(b){a.push(b)};this.pop=function(){if(b==a.length)return null;return a[b++]};this.unpop=function(){if(b>0)b--};this.peek=function(){if(b==a.length)return null;return a[b]};this.peekNext=function(){if(b+1==a.length)return null;else return a[b+1]};this.reset=function(){b=0};this.dump=function(){J("--- TOKENS.DUMP -------------------");for(var b=0;b<a.length;b++){J(a[b].toString())}J("--- /TOKENS.DUMP ------------------")}};var z=-1;var A=1;var B=2;var C=3;var D=4;var E=5;var F=6;var G=7;var H=function(a,b,c,d){this.toString=function(){return a+1+","+b+" : "+(c==z?"ID-":"OP-")+d};this.row=function(){return a+1};this.col=function(){return b};this.type=function(){return c};this.ident=function(){return c==z};this.str=function(){return d}};var I=function(a){var b=new y;var c=null;var d=0;var e=0;var f=false;var g=false;var h=0;for(var i=0;i<a.length;i++){for(var j=0;j<a[i].length;j++){var k=a[i].charAt(j);if(f&&k!=")"){if(c==null){c="";e=i;d=j}c+=k}else if(f&&k==")"){if(c!=null){b.push(new H(e,d,z,c));c=null}b.push(new H(i,j,D,")"));f=false}else if(g&&k!='"'){c+=k}else if(g&&k=='"'){b.push(new H(e,d,z,c));g=false;c=null}else if(k=="("){if(c!=null){b.push(new H(e,d,z,c));c=null}b.push(new H(i,j,C,"("));f=true}else if(k=='"'){if(c!=null){b.push(new H(e,d,z,c));c=null}g=true;c="";e=i;d=j}else if(k==" "||k=="  "){if(c!=null){b.push(new H(e,d,z,c));c=null}}else if(k==":"||k=="{"||k=="}"||k=="."||k==">"){if(k=="{")h++;else if(k=="}")h--;if(c!=null){b.push(new H(e,d,z,c));c=null}var l;if(k==":")l=G;else if(k=="{")l=A;else if(k=="}")l=B;else if(k==".")l=E;else l=F;b.push(new H(i,j,l,k))}else if(c==null){c=k;d=j;e=i}else{c+=k}}if(g||f)c+="\n";else if(c!=null){b.push(new H(e,d,z,c));c=null}}return b};var J=function(a){};this.generate=function(a){var b=a.split("\n");var c=[];var d=false;for(var e=0;e<b.length;e++){for(var f=0;f<b[e].length;f++){if(b[e].charAt(f)=='"'){if(d==false)d='"';else if(d=='"')d=false}else if(b[e].charAt(f)=="#"&&d==false){c.push(b[e].substring(f));b[e]=b[e].substring(0,f);break}}}var g=I(b);if(!(g instanceof y)){J("ERROR: "+g);return}g.dump();var h=[];var i=new u;var j=x(null,i,0,g,h,true);if(h.length>0)return h;if(i.count()==0){i.add("","actor")}var k=t(i,j,true);var l=document.createElement("canvas");if(!l.getContext)return null;var m=l.getContext("2d");if(!m)return null;l.height=i.getHeight();l.width=i.getWidth(m);if(window.devicePixelRatio){var n=l.width;var o=l.height;l.width=n*window.devicePixelRatio;l.height=o*window.devicePixelRatio;l.style.width=n;l.style.height=o;m.scale(window.devicePixelRatio,window.devicePixelRatio)}m.translate(.5,.5);i.draw(l);return l}}
